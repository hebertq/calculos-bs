CREATE OR REPLACE FUNCTION registrar_marcacion_x_id(
    empleado_id INTEGER,
    hora_entrada TIMESTAMP,
    hora_salida TIMESTAMP,
    bono_cumplimiento NUMERIC DEFAULT 0,
    tiempo_comida NUMERIC DEFAULT 0,
    pagar_como_extra BOOLEAN DEFAULT FALSE,  -- Nuevo parámetro: indicar si se paga como extra
    company_id INTEGER DEFAULT 1
)
RETURNS INTEGER AS $$  -- Devuelve el ID de la marcación creada
DECLARE
    marcacion_id INTEGER;
    horas_ordinarias NUMERIC(5,2);
    horas_extras NUMERIC(5,2);
    anio_marcacion INTEGER;
    mes_marcacion INTEGER;
BEGIN
    -- Validar los parámetros de entrada
    IF empleado_id IS NULL THEN
        RAISE EXCEPTION 'El empleado_id es obligatorio.';
    END IF;
    IF hora_entrada IS NULL AND hora_salida IS NULL THEN
        RAISE EXCEPTION 'Se debe proporcionar al menos la hora de entrada o la hora de salida.';
    END IF;
    IF bono_cumplimiento IS NULL THEN
        RAISE EXCEPTION 'El bono de cumplimiento no puede ser nulo.';
    END IF;
    IF tiempo_comida IS NULL THEN
        RAISE EXCEPTION 'El tiempo de comida no puede ser nulo.';
    END IF;

    -- Validar que no exista una marcación en el mismo horario para el empleado
    SELECT id INTO marcacion_id
    FROM attendance_attendance
    WHERE employee_id = empleado_id
      AND (
        (check_in <= hora_entrada AND check_out >= hora_entrada) OR
        (check_in <= hora_salida AND check_out >= hora_salida) OR
        (check_in <= hora_entrada AND check_out >= hora_entrada) OR
        (check_in <= hora_salida AND check_out  >= hora_salida)
      );
      
    IF marcacion_existente IS NOT NULL THEN
        RAISE EXCEPTION 'Ya existe una marcación para este empleado en el horario especificado.';
    END IF;

    -- Calcular horas ordinarias y extras
    IF pagar_como_extra THEN
        horas_ordinarias := 0;
        horas_extras := EXTRACT(EPOCH FROM (hora_salida - hora_entrada)) / 3600;
    ELSE
       SELECT 
            horas_laborales, 
            horas_extras
        INTO 
            horas_ordinarias, 
            horas_extras
        FROM 
            calcular_horas_laborales(hora_entrada, hora_salida,tiempo_comida);
    END IF;

    -- Extraer año y mes de la hora de entrada
    anio_marcacion := EXTRACT(YEAR FROM hora_entrada);
    mes_marcacion := EXTRACT(MONTH FROM hora_entrada);

    -- Insertar la nueva marcación en la tabla attendance_attendance (nombre de tabla de Odoo)
    -- y obtener el ID de la marcación insertada usando INSERT ... VALUES
    INSERT INTO attendance_attendance (
        employee_id,
        check_in,
        check_out,
        company_id,
        horas_ordinarias,
        horas_extras,
        anio,
        mes,
        bono_cumplimiento,
        tiempo_comida
    ) VALUES (
        empleado_id,
        hora_entrada,
        hora_salida,
        company_id,
        horas_ordinarias,
        horas_extras,
        anio_marcacion,
        mes_marcacion,
        bono_cumplimiento,
        tiempo_comida
    )
    RETURNING id INTO marcacion_id;

    -- Devolver el ID de la marcación creada
    RETURN marcacion_id;

EXCEPTION
    WHEN OTHERS THEN
        -- Manejar cualquier error que ocurra durante la inserción
        RAISE EXCEPTION 'Error al agregar la marcación: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
